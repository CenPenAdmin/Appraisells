<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Auction - Appraisells</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 30px;
      text-align: center;
    }
    .auction-box {
      background: white;
      padding: 20px;
      max-width: 600px;
      margin: auto;
      box-shadow: 0 0 10px #ccc;
      border-radius: 10px;
    }
    .btn {
      background: #663399;
      color: white;
      padding: 10px 20px;
      margin-top: 10px;
      border: none;
      font-size: 1em;
      border-radius: 6px;
      cursor: pointer;
    }
    ul#bids {
      list-style: none;
      padding: 0;
      max-height: 200px;
      overflow-y: scroll;
      text-align: left;
    }
    li {
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="auction-box">
    <h2>Live Auction</h2>
    <p><strong>Auction Ends In:</strong> <span id="timer"></span></p>
    <p><strong>Current Highest Bid:</strong> <span id="highest">0 Pi</span> by <span id="leader">None</span></p>

    <button class="btn" onclick="placeBid()">Place a Bid</button>

    <h3>Live Bids:</h3>
    <ul id="bids"></ul>

    <p id="status"></p>
  </div>

  <script>
    Pi.init({ version: "2.0", sandbox: true });

    const user = JSON.parse(localStorage.getItem("piUser"));
    if (!user) {
      alert("Please login first via the home page.");
      window.location.href = "index.html";
    }

    // Real auction end time (UTC)
    const endTime = new Date("2025-12-31T23:59:59Z");
    const ws = new WebSocket("wss://appraisells-backend.onrender.com");

    function updateTimer() {
      const now = new Date();
      const diff = endTime - now;

      if (diff <= 0) {
        document.getElementById("timer").innerText = "Auction Ended";
        document.getElementById("status").innerText = "Auction is over.";
        document.querySelector(".btn").disabled = true;
        return;
      }

      const minutes = Math.floor((diff / 1000 / 60) % 60);
      const seconds = Math.floor((diff / 1000) % 60);
      document.getElementById("timer").innerText = `${minutes}m ${seconds}s`;
    }

    setInterval(updateTimer, 1000);

    ws.onmessage = (e) => {
      const data = JSON.parse(e.data);
      if (data.error) {
        alert(data.error);
        return;
      }

      document.getElementById("highest").innerText = data.highest + " Pi";
      document.getElementById("leader").innerText = data.user;

      const li = document.createElement("li");
      li.innerText = `${data.user}: ${data.amount} Pi`;
      document.getElementById("bids").prepend(li);
    };

    function placeBid() {
      const amt = prompt("Enter your bid in Pi:");
      if (!amt || isNaN(amt) || parseFloat(amt) <= 0) {
        alert("Invalid bid.");
        return;
      }

      ws.send(JSON.stringify({
        type: "bid",
        amount: amt,
        user: user.username
      }));
    }
  </script>
</body>
</html>
