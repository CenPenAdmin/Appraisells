<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Live Auction</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .btn { padding: 10px 20px; cursor: pointer; }
    #bid-list { margin-top: 20px; height: 200px; overflow: auto; border: 1px solid #ccc; }
  </style>
</head>
<body>

  <div id="userInfo"></div> <!-- Display Pi username here -->
  <h1>Live Auction</h1>
  <p>Highest Bid: <span id="current">0 Pi</span></p>
  <button class="btn" onclick="placeBid()">Place Bid</button>
  <ul id="bid-list"></ul>

  <script>
  // Load user from localStorage
  const storedUser = localStorage.getItem("piUser");

  if (storedUser) {
    const user = JSON.parse(storedUser);
    console.log("Logged in user:", user.username);
    document.getElementById("userInfo").innerText = `Welcome, ${user.username}`;
  } else {
    alert("You must login through the Pi Browser first.");
    window.location.href = "index.html"; // Redirect to login
  }

  Pi.init({ version: "2.0", sandbox: true });

  let ws = new WebSocket("wss://appraisells-backend.onrender.com/auction");

  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    document.getElementById('current').innerText = data.highest + " Pi";
    const li = document.createElement('li');
    li.innerText = `${data.user}: ${data.amount} Pi`;
    document.getElementById('bid-list').appendChild(li);
  };

  function placeBid() {
    const user = JSON.parse(localStorage.getItem("piUser"))?.username || "Anonymous";
    const amount = prompt("Enter bid amount in Pi:");
    if (!amount) return;
    ws.send(JSON.stringify({ type: "bid", amount, user }));
  }
</script>

</body>
</html>
